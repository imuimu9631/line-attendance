<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ç®¡ç† - LINEæ‰“åˆ»</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .clock {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .date {
            font-size: 18px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .user-code {
            font-size: 16px;
            opacity: 0.9;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .action-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .action-btn .label {
            font-size: 14px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .login-container {
            text-align: center;
            padding: 40px 20px;
        }

        .login-container .logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .setup-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            font-family: monospace;
        }

        .debug-info h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
        <div id="debugInfo" class="card debug-info" style="display: none;">
            <h3>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <div id="debugContent">
                <p>LIFFçŠ¶æ…‹: <span id="liffStatus">æœªç¢ºèª</span></p>
                <p>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: <span id="loginStatus">æœªç¢ºèª</span></p>
                <p>ã‚¨ãƒ©ãƒ¼: <span id="errorInfo">ãªã—</span></p>
                <p>URL: <span id="currentUrl">-</span></p>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="loadingScreen" class="card loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #666;">LIFFåˆæœŸåŒ–ä¸­...</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
        <div id="errorScreen" class="card" style="display: none;">
            <div class="header">
                <div class="logo">âš ï¸</div>
                <h1>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
            </div>
            <div id="errorMessage" class="message error"></div>
            <button class="btn btn-primary" onclick="location.reload()">
                å†èª­ã¿è¾¼ã¿
            </button>
            <button class="btn btn-info" onclick="showDebugInfo()">
                ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
            </button>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="card login-container" style="display: none;">
            <div class="logo">ğŸ±</div>
            <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #666; margin: 20px 0;">LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
            <button class="btn btn-primary" onclick="liffLogin()">
                LINEã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button class="btn btn-info" onclick="showDebugInfo()" style="margin-top: 10px;">
                ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            </button>
        </div>

        <!-- åˆæœŸè¨­å®šç”»é¢ -->
        <div id="setupScreen" class="card" style="display: none;">
            <div class="header">
                <h1>åˆæœŸè¨­å®š</h1>
                <p style="color: #666;">å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
            </div>
            <div id="setupUserInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p>åå‰: <span id="setupUserName">-</span></p>
                <p style="font-size: 12px; color: #666;">LINE ID: <span id="setupUserId">-</span></p>
            </div>
            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label>å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰</label>
                    <input type="text" 
                           id="setupEmployeeCode" 
                           class="form-control" 
                           placeholder="ä¾‹: EMP001"
                           required>
                </div>
                <button type="submit" class="btn btn-primary">
                    è¨­å®šã‚’ä¿å­˜
                </button>
            </form>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" style="display: none;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± -->
            <div class="card">
                <div class="header">
                    <div class="logo">ğŸ±</div>
                    <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                </div>

                <div class="clock" id="clock">00:00:00</div>
                <div class="date" id="date">2024å¹´1æœˆ1æ—¥ æœˆæ›œæ—¥</div>

                <div class="user-info">
                    <div class="user-name" id="userName">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div class="user-code" id="userCode">-</div>
                </div>
            </div>

            <!-- æ‰“åˆ»ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center;">æ‰“åˆ»</h2>
                
                <div id="messageArea"></div>

                <div class="action-buttons">
                    <div class="action-btn" onclick="selectAction('in')">
                        <div class="icon">ğŸ¢</div>
                        <div class="label">å‡ºå‹¤</div>
                    </div>
                    <div class="action-btn" onclick="selectAction('out')">
                        <div class="icon">ğŸ </div>
                        <div class="label">é€€å‹¤</div>
                    </div>
                </div>

                <button id="punchBtn" class="btn btn-success" onclick="punch()" disabled>
                    æ‰“åˆ»ã™ã‚‹
                </button>

                <button class="btn btn-info" onclick="scanQR()">
                    ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹
                </button>
            </div>

            <!-- æœ¬æ—¥ã®è¨˜éŒ² -->
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“‹ æœ¬æ—¥ã®æ‰“åˆ»è¨˜éŒ²</h2>
                <div id="recordsArea">
                    <p style="text-align: center; color: #999;">æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <!-- è¨­å®š -->
            <div class="card">
                <button class="btn btn-primary" onclick="changeEmployeeCode()">
                    âš™ï¸ å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰å¤‰æ›´
                </button>
                <button class="btn btn-danger" onclick="liffLogout()">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const LIFF_ID = '2008444059-JmVGoO57';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyqpql1mobPxD_2qrnfSb7CobAKwjgjC-dD7ELLGNSBrOtw1LDpNJv7Ia3LekNtuv98/exec';
        
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let liffProfile = null;
        let employeeCode = null;
        let selectedAction = null;
        let records = [];

        // ========================================
        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°
        // ========================================
        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
            document.getElementById('currentUrl').textContent = window.location.href;
        }

        function showError(message) {
            debugLog('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', message);
            document.getElementById('errorInfo').textContent = message;
            document.getElementById('errorMessage').textContent = message;
            hideAllScreens();
            document.getElementById('errorScreen').style.display = 'block';
        }

        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        window.onload = async function() {
            debugLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            updateClock();
            setInterval(updateClock, 1000);
            
            try {
                await initializeLiff();
            } catch (error) {
                showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };

        // LIFFåˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function initializeLiff() {
            debugLog('LIFFåˆæœŸåŒ–é–‹å§‹');
            document.getElementById('liffStatus').textContent = 'åˆæœŸåŒ–ä¸­...';
            
            try {
                // LIFFåˆæœŸåŒ–
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: true // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã«
                });
                
                debugLog('LIFFåˆæœŸåŒ–æˆåŠŸ');
                document.getElementById('liffStatus').textContent = 'åˆæœŸåŒ–å®Œäº†';
                
                // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
                const isLoggedIn = liff.isLoggedIn();
                document.getElementById('loginStatus').textContent = isLoggedIn ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                debugLog('ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹', isLoggedIn);
                
                if (isLoggedIn) {
                    try {
                        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                        const profile = await liff.getProfile();
                        liffProfile = profile;
                        debugLog('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ', profile);
                        
                        // å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ç¢ºèª
                        const storageKey = 'employeeCode_' + profile.userId;
                        employeeCode = localStorage.getItem(storageKey);
                        debugLog('å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰', employeeCode);
                        
                        if (employeeCode) {
                            // ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                            showMainScreen();
                        } else {
                            // åˆæœŸè¨­å®šç”»é¢è¡¨ç¤º
                            showSetupScreen();
                        }
                    } catch (profileError) {
                        debugLog('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼', profileError);
                        showError('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                    showLoginScreen();
                }
            } catch (initError) {
                debugLog('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', initError);
                document.getElementById('liffStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
                
                // LIFFãŒä½¿ç”¨ã§ããªã„ç’°å¢ƒã®å ´åˆ
                if (initError.code === 'INVALID_CONFIG') {
                    showError('LIFF IDãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                } else if (!liff.isInClient()) {
                    // LINEå¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
                    showLoginScreen();
                } else {
                    showError('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + initError.message);
                }
            }
        }

        // ========================================
        // ç”»é¢åˆ¶å¾¡
        // ========================================
        function hideAllScreens() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
        }

        function showLoginScreen() {
            debugLog('ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('loginScreen').style.display = 'block';
        }

        function showSetupScreen() {
            debugLog('åˆæœŸè¨­å®šç”»é¢è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('setupScreen').style.display = 'block';
            
            if (liffProfile) {
                document.getElementById('setupUserName').textContent = liffProfile.displayName;
                document.getElementById('setupUserId').textContent = liffProfile.userId;
            }
        }

        function showMainScreen() {
            debugLog('ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º');
            hideAllScreens();
            document.getElementById('mainScreen').style.display = 'block';
            
            if (liffProfile) {
                document.getElementById('userName').textContent = liffProfile.displayName;
                document.getElementById('userCode').textContent = 'å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰: ' + employeeCode;
            }
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨˜éŒ²èª­ã¿è¾¼ã¿
            loadRecords();
        }

        // ========================================
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        // ========================================
        function liffLogin() {
            debugLog('ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹');
            liff.login();
        }

        function liffLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                debugLog('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                liff.logout();
                window.location.reload();
            }
        }

        // åˆæœŸè¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('setupEmployeeCode').value.trim();
            
            if (code) {
                employeeCode = code;
                const storageKey = 'employeeCode_' + liffProfile.userId;
                localStorage.setItem(storageKey, code);
                debugLog('å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ä¿å­˜', code);
                
                // Google Sheetsã«é€ä¿¡
                await sendToSheets('addEmployee', {
                    code: employeeCode,
                    name: liffProfile.displayName,
                    lineId: liffProfile.userId
                });
                
                showMainScreen();
            }
        });

        // å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰å¤‰æ›´
        function changeEmployeeCode() {
            const newCode = prompt('æ–°ã—ã„å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', employeeCode);
            if (newCode && newCode.trim()) {
                employeeCode = newCode.trim();
                const storageKey = 'employeeCode_' + liffProfile.userId;
                localStorage.setItem(storageKey, employeeCode);
                document.getElementById('userCode').textContent = 'å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰: ' + employeeCode;
                showMessage('å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ
        function selectAction(type) {
            selectedAction = type;
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            document.getElementById('punchBtn').disabled = false;
            document.getElementById('punchBtn').textContent = type === 'in' ? 'å‡ºå‹¤ã‚’è¨˜éŒ²' : 'é€€å‹¤ã‚’è¨˜éŒ²';
        }

        // æ‰“åˆ»
        async function punch() {
            if (!selectedAction) {
                showMessage('æ‰“åˆ»ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const record = {
                employeeCode: employeeCode,
                employeeName: liffProfile.displayName,
                lineUserId: liffProfile.userId,
                type: selectedAction,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ja-JP'),
                method: 'æ‰‹å‹•',
                timestamp: new Date().toISOString()
            };
            
            records.push(record);
            saveRecords();
            
            // Google Sheetsã«é€ä¿¡
            await sendToSheets('punch', record);
            
            const actionText = selectedAction === 'in' ? 'å‡ºå‹¤' : 'é€€å‹¤';
            showMessage(`${actionText}ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`, 'success');
            
            updateRecordsDisplay();
            
            // ãƒªã‚»ãƒƒãƒˆ
            selectedAction = null;
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('punchBtn').disabled = true;
            document.getElementById('punchBtn').textContent = 'æ‰“åˆ»ã™ã‚‹';
        }

        // QRã‚¹ã‚­ãƒ£ãƒ³
        async function scanQR() {
            try {
                if (!liff.scanCodeV2) {
                    showMessage('QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                    return;
                }
                const result = await liff.scanCodeV2();
                debugLog('QRã‚¹ã‚­ãƒ£ãƒ³çµæœ', result);
                // QRå‡¦ç†
            } catch (error) {
                debugLog('QRã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼', error);
                showMessage('QRã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        // ========================================
        function loadRecords() {
            const saved = localStorage.getItem('attendance_records');
            if (saved) {
                records = JSON.parse(saved);
            }
            updateRecordsDisplay();
        }

        function saveRecords() {
            localStorage.setItem('attendance_records', JSON.stringify(records));
        }

        function updateRecordsDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(r => r.date === today);
            
            const recordsArea = document.getElementById('recordsArea');
            if (todayRecords.length === 0) {
                recordsArea.innerHTML = '<p style="text-align: center; color: #999;">æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                const html = '<table><thead><tr><th>æ™‚åˆ»</th><th>ç¨®é¡</th></tr></thead><tbody>' +
                    todayRecords.map(r => `<tr><td>${r.time}</td><td>${r.type === 'in' ? 'å‡ºå‹¤' : 'é€€å‹¤'}</td></tr>`).join('') +
                    '</tbody></table>';
                recordsArea.innerHTML = html;
            }
        }

        // Google Sheetsé€ä¿¡
        async function sendToSheets(action, data) {
            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...data })
                });
                debugLog('Google Sheetsé€ä¿¡å®Œäº†', data);
            } catch (error) {
                debugLog('é€ä¿¡ã‚¨ãƒ©ãƒ¼', error);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            if (messageArea) {
                messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
                setTimeout(() => { messageArea.innerHTML = ''; }, 3000);
            }
        }

        // æ™‚è¨ˆæ›´æ–°
        function updateClock() {
            const now = new Date();
            const clockElement = document.getElementById('clock');
            const dateElement = document.getElementById('date');
            
            if (clockElement) {
                clockElement.textContent = now.toLocaleTimeString('ja-JP');
            }
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('ja-JP', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                });
            }
        }
    </script>
</body>
</html>